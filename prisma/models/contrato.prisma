// ========================================
// CONTRACT
// ========================================

model Contract {
    id String @id @default(cuid())

    unitId   String
    tenantId String
    adminId  String

    // Información financiera con validaciones
    rent              Float // postgres @db.Decimal(10, 2) // Precisión monetaria
    deposit           Float // postgres @db.Decimal(10, 2)
    utilitiesIncluded Boolean @default(false)

    // Campos adicionales importantes
    securityDeposit Float? // postgres @db.Decimal(10, 2)
    lateFeePenalty  Float? // postgres @db.Decimal(5, 2) // Porcentaje
    gracePeriodDays Int    @default(5)

    // Fechas con validación
    startDate DateTime
    endDate   DateTime

    // ESTADO EXPANDIDO - Incluye proceso de alquiler
    status ContractStatus @default(INITIATED) // Cambiado de DRAFT a INITIATED

    notes String?
    terms String? // postgres @db.Text // Usar Text para contenido largo

    autoRenewal   Boolean @default(false)
    renewalPeriod Int?

    // Prioridad del proceso
    priority ContractPriority @default(NORMAL)

    // Fecha estimada de finalización del proceso
    estimatedCompletionDate DateTime?

    // Información financiera propuesta (puede diferir de la final)
    proposedRent            Float? // postgres @db.Decimal(10, 2)
    proposedDeposit         Float? // postgres @db.Decimal(10, 2)
    proposedSecurityDeposit Float? // postgres @db.Decimal(10, 2)

    // Documentos del proceso almacenados como JSON
    processDocuments String? // postgres @db.Text
    // Ejemplo: [{"id": "doc1", "fileName": "income.pdf", "fileType": "application/pdf", "filePath": "...", "fileSize": 1024, "documentType": "INCOME_VERIFICATION", "uploadedAt": "2024-01-01", "uploadedBy": "admin123"}]

    // Motivos de rechazo/cancelación
    rejectionReason    String?
    cancellationReason String?

    // Fechas del proceso expandido
    initiatedAt DateTime  @default(now()) // Cuándo se inició el proceso
    reviewedAt  DateTime? // Cuándo se revisó la aplicación
    approvedAt  DateTime? // Cuándo se aprobó para contrato
    signedAt    DateTime? // Cuándo se firmó el contrato
    activatedAt DateTime? // Cuándo se activó el contrato

    // Campos de auditoría existentes
    terminatedAt      DateTime?
    terminationReason String?

    unit   Unit   @relation(fields: [unitId], references: [id], onDelete: Restrict)
    tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

    admins Admin[] @relation("ContractAdmins")

    payments  Payment[]
    documents ContractDocument[] // Documentos del contrato firmado

    additionalResidents User[] @relation("AdditionalResidents")

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([unitId, startDate])
    @@index([adminId]) // Buscar contratos por admin (quién los gestiona)
    @@index([endDate]) // Útil para contratos próximos a vencer
    @@index([autoRenewal]) // Consultar contratos con renovación automática
    @@index([tenantId, status]) // Filtrar contratos activos por inquilino
    @@index([status])
    @@index([tenantId])
    @@index([startDate, endDate])
    @@index([signedAt]) // Nuevo índice
    @@index([priority]) // Para filtrar por prioridad
    @@index([initiatedAt]) // Para ordenar por fecha de inicio del proceso
    @@index([status, initiatedAt]) // Consultas de procesos activos
    @@map("contracts")
}

enum ContractStatus {
    // === FASE DE PROCESO ===
    INITIATED // Proceso iniciado - unidad reservada
    UNDER_REVIEW // Aplicación en revisión
    DOCUMENTATION // Recopilando documentación
    APPROVED // Aprobado para contrato

    // === FASE DE CONTRATO ===
    DRAFT // Borrador de contrato
    PENDING // Pendiente de firma
    ACTIVE // Contrato activo

    // === ESTADOS FINALES ===
    EXPIRED // Vencido
    RENEWED // Renovado
    TERMINATED // Terminado
    CANCELLED // Cancelado
    REJECTED // Rechazado en proceso
}

model ContractDocument {
    id         String @id @default(cuid())
    contractId String

    fileName     String
    fileType     String
    filePath     String
    fileSize     Int
    documentType DocumentContractType

    uploadedAt DateTime @default(now())

    contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

    @@map("contract_documents")
}

enum DocumentContractType {
    // Documentos del proceso
    TENANT_APPLICATION // Solicitud del inquilino
    INCOME_VERIFICATION // Verificación de ingresos
    EMPLOYMENT_LETTER // Carta laboral
    BANK_STATEMENTS // Extractos bancarios
    REFERENCES_CHECK // Verificación de referencias
    CREDIT_REPORT // Reporte crediticio
    IDENTITY_DOCUMENTS // Documentos de identidad
    PROPERTY_INSPECTION // Inspección de la propiedad
    INSURANCE_PROOF // Prueba de seguro

    // Documentos del contrato firmado
    CONTRACT_SIGNED // Contrato firmado
    TENANT_ID // ID del inquilino
    INCOME_PROOF // Comprobante de ingresos
    REFERENCES // Referencias
    INVENTORY // Inventario
    PHOTOS // Fotos
    OTHER // Otros documentos
}

// ========================================
// PAYMENTS
// ========================================

model Payment {
    id         String @id @default(cuid())
    contractId String

    amount      Float // postgres @db.Decimal(10, 2)
    dueDate     DateTime
    paidDate    DateTime?
    paymentType PaymentType
    status      PaymentStatus @default(PENDING)

    // Campos adicionales
    paymentMethod PaymentMethod?
    transactionId String? // ID de transacción bancaria
    receiptNumber String? // Número de recibo

    // Penalizaciones
    lateFeeAmount  Float? // postgres @db.Decimal(8, 2)
    lateFeeApplied Boolean @default(false)

    reference String?
    notes     String?

    contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([contractId])
    @@index([dueDate])
    @@index([status])
    @@index([paymentMethod])
    @@index([contractId, dueDate]) // Filtrar pagos vencidos por contrato
    @@index([status, paidDate]) // Consultar pagos pagados/pendientes con fechas
    @@map("payments")
}

enum PaymentMethod {
    CASH
    BANK_TRANSFER
    CHECK
    CREDIT_CARD
    DEBIT_CARD
    DIGITAL_WALLET
    OTHER
}

enum PaymentType {
    RENT
    DEPOSIT
    UTILITIES
    MAINTENANCE
    LATE_FEE
    OTHER
}

enum PaymentStatus {
    PENDING // Pendiente
    PAID // Pagado
    OVERDUE // Vencido
    PARTIAL // Parcial
    CANCELLED // Cancelado
}

enum ContractPriority {
    LOW
    NORMAL
    HIGH
    URGENT
}
